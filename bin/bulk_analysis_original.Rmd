---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
```{r includes}
library(openxlsx)
library(tidyverse)
library(scales)
library(ggthemes)
library(patchwork)

library(scater)
library(org.Mm.eg.db)
library(msigdbr)

library(clusterProfiler)
library(enrichplot)
library(ggrepel)
library(ggrastr)

filter = dplyr::filter

theme_set(theme_bw(base_size = 7, base_line_size = 1/.pt))
```

```{r read_deg}
d_exp <- read.xlsx('./data/bulk_MkP_cd48/bfx1622.deseq-results.separate.xlsx', sheet = 2)
d_exp$Entrez_ID <- mapIds(org.Mm.eg.db, keys = d_exp$Ensembl_ID, column="ENTREZID", keytype="ENSEMBL")
```

# volcano
```{r}
sce = readRDS('./data/210712_sce.rds')
df = data.frame(
  CD48_plus = rowSums(sign(counts(sce)[,sce$cell_type3 == 'MkP_CD48+']))/
  sum(sce$cell_type3 == 'MkP_CD48+'),
  CD48_minus = rowSums(sign(counts(sce)[, sce$cell_type3 == 'MkP_CD48-']))/
  sum(sce$cell_type3 == 'MkP_CD48-'))

df$Ensembl_ID = rowData(sce)[,'ENSEMBL']
```

```{r}
mk_markers <- c('Pf4','Itga2b','Cd9','Rap1b', 'F2r','Plek',
                'Gata1','Mef2c', 'Vwf','Gata2', 'Cd48')

scale_forw2 <- function(x){pmin(x,10+(x-10)/5)}
scale_inv2 <- function(x){pmax(x,5*(x-10)+10)}
custom_t2 <- trans_new('custom_scale2', 
                      transform = 'scale_forw2', 
                      inverse = 'scale_inv2')

pval_thresh = 1e-02
logFC_thresh = 1

# insert variation here
d_exp <- left_join(d_exp, df)
d_exp$expressing <- d_exp$CD48_plus
d_exp$expressing[d_exp$log2FoldChange <0] <- d_exp$CD48_minus[d_exp$log2FoldChange <0]
d_exp$expressing[is.na(d_exp$expressing)] = 0
d_exp$expressing <- cut(d_exp$expressing, 
                        breaks = c(0,0.1,0.25,0.5,0.75, 0.9,1),
                        include.lowest = T,right = F)

d_exp$code <- 0
d_exp$code[abs(d_exp$log2FoldChange) > logFC_thresh] <- 1
d_exp$code[d_exp$padj < pval_thresh] <- 2
d_exp$code[d_exp$padj < pval_thresh & abs(d_exp$log2FoldChange) > logFC_thresh] <- 3
d_exp$code <- factor(d_exp$code)
```

```{r}
mk_volcano <- ggplot(d_exp, aes(x = -log2FoldChange, y = -log10(padj))) + 
  geom_point(data = d_exp %>% filter(padj < pval_thresh | abs(log2FoldChange) > logFC_thresh),
             aes(col = code, shape = expressing), size = 1.5, alpha = .75) + 
  # subsample non-significant genes to reduce plot size
  geom_point_rast(data = d_exp %>% filter(padj > pval_thresh & abs(log2FoldChange) < logFC_thresh) %>% 
                    slice_sample(prop = 0.25), 
                  aes(col = code, shape = expressing), size = 0.5, alpha = .5, color = 'grey90') + 
  #scale_shape_discrete(solid=T) +
  scale_shape_manual(values = c(3,1,2,0,0,0)) +
  scale_y_continuous(trans =custom_t2, breaks = c(0,5,10,20,30,40)) +
  geom_hline(yintercept = -log10(pval_thresh)) + 
  geom_vline(xintercept = -logFC_thresh) + 
  geom_vline(xintercept = logFC_thresh) +
  scale_color_manual(values = c('cadetblue','darkorange','red')) + 
  geom_label_repel(data = d_exp %>% 
                     dplyr::filter(Gene_Symbol %in% mk_markers), 
                   max.overlaps = 50,alpha = 1, col = 'grey30', size = 8/.pt,force = 3, force_pull = 0.5,
                   aes(x = -log2FoldChange, y = -log10(padj), 
                       label = Gene_Symbol)) +

  geom_text_repel(data = d_exp %>% dplyr::filter(padj<1e-10), 
                  max.overlaps = 50,alpha = 1, col = 'red', 
                  size =7/.pt,
                  aes(x = -log2FoldChange, y = -log10(padj), label = Gene_Symbol)) +
  
  geom_point(data = d_exp %>% dplyr::filter(Gene_Symbol %in% mk_markers),col = 'black')  + guides(col = 'none')

mk_volcano
# save

ggsave('./figures/de_mk.markers.pdf',mk_volcano, width = 3.5, height =3)

```
# preprocess gene lists
```{r input_lists}
ranked_d_exp <- d_exp %>% arrange(desc(log2FoldChange)) %>% 
  dplyr::select(Gene_Symbol, Ensembl_ID, Entrez_ID, log2FoldChange)

ranked_ens <- ranked_d_exp$log2FoldChange
names(ranked_ens) <- ranked_d_exp$Ensembl_ID

ranked_entrez <- ranked_d_exp$log2FoldChange
names(ranked_entrez) <- ranked_d_exp$Entrez_ID


deg <- d_exp %>% filter(padj <0.01)
deg_up <- d_exp %>% filter(log2FoldChange > 0, padj <0.01)
deg_dn <- d_exp %>% filter(log2FoldChange < 0, padj <0.01)
```
# GO
## Biological process
```{r}
gsea_go_bp <- gseGO(ranked_entrez[!is.na(ranked_entrez)], 
                 OrgDb = org.Mm.eg.db, ont = 'BP') %>% 
  setReadable(OrgDb = org.Mm.eg.db)

up_go_bp <- enrichGO(deg_up$Ensembl_ID, OrgDb=org.Mm.eg.db, keyType='ENSEMBL', ont='BP')%>% setReadable(OrgDb = org.Mm.eg.db)
dn_go_bp <- enrichGO(deg_dn$Ensembl_ID, OrgDb=org.Mm.eg.db, keyType='ENSEMBL', ont='BP') %>% setReadable(OrgDb = org.Mm.eg.db)
```

```{r plot}
p1 <- dotplot(gsea_go_bp %>% filter(NES > 0),x = 'NES', showCategory = 25,
              font.size =6, label_format=20)  +
  labs(title = 'CD48hi', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none')

p2 <- dotplot(gsea_go_bp %>% filter(NES < 0) %>% mutate(`-NES` = - NES), x = '-NES', showCategory = 25,
              font.size =6, label_format=20)  + 
  labs(title = 'CD48lo', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none') 

p3 <- dotplot(up_go_bp, showCategory = 25, 
              font.size =6, label_format=20) + 
  labs(title = 'CD48hi', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none') 

p4 <- dotplot(dn_go_bp, showCategory = 25,
              font.size =6, label_format=20) + 
  labs(title = 'CD48lo', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none')


p_gobp <- p1 + p2 + p3 + p4
ggsave('./figures/go_bp.pdf',
       plot = p_gobp, width =8, height = 8)
```

```{r write_table}
write.xlsx(x = list('Over-representation_48hi' = up_go_bp@result %>% filter(p.adjust<0.01),
                    'Over-representation_48lo' = dn_go_bp@result %>% filter(p.adjust<0.01),
                    'GSEA_48hi' = gsea_go_bp@result %>% filter(NES >0),
                    'GSEA_48lo' = gsea_go_bp@result %>% filter(NES <0)),
           file = './figures/tables/go_bp.xlsx', 
           asTable = T)
```

## Molecular function
```{r}
gsea_go_mf <- gseGO(ranked_entrez[!is.na(ranked_entrez)], 
                 OrgDb = org.Mm.eg.db, ont = 'MF') %>% 
  setReadable(OrgDb = org.Mm.eg.db)

up_go_mf <- enrichGO(deg_up$Ensembl_ID, OrgDb=org.Mm.eg.db, keyType='ENSEMBL', ont='MF')%>% setReadable(OrgDb = org.Mm.eg.db)
dn_go_mf <- enrichGO(deg_dn$Ensembl_ID, OrgDb=org.Mm.eg.db, keyType='ENSEMBL', ont='MF') %>% setReadable(OrgDb = org.Mm.eg.db)
```

```{r plot}
p1 <- dotplot(gsea_go_mf %>% filter(NES > 0),x = 'NES', showCategory = 25,
              font.size =6, label_format=20)  +
  labs(title = 'CD48hi', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none')

p2 <- dotplot(gsea_go_mf %>% filter(NES < 0) %>% mutate(`-NES` = - NES), x = '-NES', showCategory = 25,
              font.size =6, label_format=20)  + 
  labs(title = 'CD48lo', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none')

p3 <- dotplot(up_go_mf, showCategory = 25, 
              font.size =6, label_format=20) + 
  labs(title = 'CD48hi', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none')

p4 <- dotplot(dn_go_mf, showCategory = 25,
              font.size =6, label_format=20) + 
  labs(title = 'CD48lo', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none')


p_gomf <- p1 + p2 + p3 + p4
ggsave('./figures/go_mf.pdf',
       plot = p_gomf, width =8, height = 8)

```

```{r write_table}
write.xlsx(x = list('Over-representation_48hi' = up_go_mf@result %>% filter(p.adjust<0.01),
                    'Over-representation_48lo' = dn_go_mf@result %>% filter(p.adjust<0.01),
                    'GSEA_48hi' = gsea_go_mf@result %>% filter(NES >0),
                    'GSEA_48lo' = gsea_go_mf@result %>% filter(NES <0)),
           file = './figures/tables/go_mf.xlsx', 
           asTable = T)
```

## Cellular component
```{r}
gsea_go_cc <- gseGO(ranked_entrez[!is.na(ranked_entrez)], 
                 OrgDb = org.Mm.eg.db, ont = 'CC') %>% 
  setReadable(OrgDb = org.Mm.eg.db)

up_go_cc <- enrichGO(deg_up$Ensembl_ID, OrgDb=org.Mm.eg.db, keyType='ENSEMBL', ont='CC')%>% setReadable(OrgDb = org.Mm.eg.db)
dn_go_cc <- enrichGO(deg_dn$Ensembl_ID, OrgDb=org.Mm.eg.db, keyType='ENSEMBL', ont='CC') %>% setReadable(OrgDb = org.Mm.eg.db)
```
```{r plot}
p1 <- dotplot(gsea_go_cc %>% filter(NES > 0),x = 'NES', showCategory = 25,
              font.size =6, label_format=20)  +
  labs(title = 'CD48hi', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none')

p2 <- dotplot(gsea_go_cc %>% filter(NES < 0) %>% mutate(`-NES` = - NES), x = '-NES', showCategory = 25,
              font.size =6, label_format=20)  + 
  labs(title = 'CD48lo', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none')
 

p3 <- dotplot(up_go_cc, showCategory = 25, 
              font.size =6, label_format=20) + 
  labs(title = 'CD48hi', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none')

p4 <- dotplot(dn_go_cc, showCategory = 25,
              font.size =6, label_format=20) + 
  labs(title = 'CD48lo', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none')


p_gocc <- p1 + p2 + p3 + p4
ggsave('./figures/go_cc.pdf',
       plot = p_gocc, width =8, height = 8)

```

```{r write_table}
write.xlsx(x = list('Over-representation_48hi' = up_go_cc@result %>% filter(p.adjust<0.01),
                    'Over-representation_48lo' = dn_go_cc@result %>% filter(p.adjust<0.01),
                    'GSEA_48hi' = gsea_go_cc@result %>% filter(NES >0),
                    'GSEA_48lo' = gsea_go_cc@result %>% filter(NES <0)),
           file = './figures/tables/go_cc.xlsx', 
           asTable = T)
```

# MsigDB

```{r}
msigdb_curated <- msigdbr(species = 'Mus musculus', category = 'C2',subcategory = 'CP')
msigdb_curated_cgp <- msigdbr(species = 'Mus musculus', category = 'C2',subcategory = 'CGP')

msigdb_celltype <- msigdbr(species = 'Mus musculus', category = 'C8')
```

## curated (perturbation)
```{r}
curated_gsea_cgp <- GSEA(geneList = ranked_ens[!is.na(ranked_ens)], 
                TERM2GENE = msigdb_curated_cgp[,c('gs_name','ensembl_gene')], eps = 1e-100)%>% 
  setReadable(OrgDb = org.Mm.eg.db, keyType = 'ENSEMBL')

curated_up_cgp <- enricher(gene =deg_up$Ensembl_ID, 
                       TERM2GENE = msigdb_curated_cgp[,c('gs_name','ensembl_gene')]) %>%
  setReadable(OrgDb = org.Mm.eg.db, keyType = 'ENSEMBL')

curated_dn_cgp <- enricher(gene =deg_dn$Ensembl_ID, 
                       TERM2GENE = msigdb_curated_cgp[,c('gs_name','ensembl_gene')]) %>%
  setReadable(OrgDb = org.Mm.eg.db, keyType = 'ENSEMBL')
```

```{r plot}
p1 <- dotplot(curated_gsea_cgp %>% filter(NES > 0),x = 'NES', showCategory = 25,
              font.size =6, label_format=20)  +
  labs(title = 'CD48hi', subtitle = 'GSEA enrichment') +
  theme(legend.position = 'none')

p2 <- dotplot(curated_gsea_cgp %>% filter(NES < 0) %>% mutate(`-NES` = - NES), x = '-NES', showCategory = 25,
              font.size =6, label_format=20)  + 
  labs(title = 'CD48lo', subtitle = 'GSEA enrichment')  +
  theme(legend.position = 'none')

p3 <- dotplot(curated_up_cgp, showCategory = 25, 
              font.size =6, label_format=20) + 
  labs(title = 'CD48hi', subtitle = 'over-representation enrichment') + 
  theme(legend.position = 'none')

p4 <- dotplot(curated_dn_cgp, showCategory = 25,
              font.size =6, label_format=20) + 
  labs(title = 'CD48lo', subtitle = 'over-representation enrichment') +
  theme(legend.position = 'none')


p_cgp <- p1 + p2 + p3 + p4
ggsave('./figures/perturbations_msigdb.pdf',
       plot = p_cgp, width =11, height = 11)
```

```{r write_table}
write.xlsx(x = list('Over-representation_48hi' = curated_up_cgp@result %>% filter(p.adjust<0.01),
                    'Over-representation_48lo' = curated_dn_cgp@result %>% filter(p.adjust<0.01),
                    'GSEA_48hi' = curated_gsea_cgp@result %>% filter(NES >0),
                    'GSEA_48lo' = curated_gsea_cgp@result %>% filter(NES <0)),
           file = './figures/tables/perturbations_msigdb.xlsx', 
           asTable = T)
```

## Celltype
```{r}
ery <- msigdb_celltype %>% filter(grepl('ERYTHR', gs_name)) #%>% group_by(gs_name) %>% summarise(n=n())

mk <- msigdb_celltype %>% filter(grepl('MEGAK', gs_name)) #%>% group_by(gs_name) %>% summarise(n=n())

ly <- msigdb_celltype %>% filter(grepl('LYMPHO', gs_name)) #%>% group_by(gs_name) %>% summarise(n=n())

my <- msigdb_celltype %>% filter(grepl('MYELOID|MICROGLIA|KUPFER', gs_name))# %>% group_by(gs_name) %>% summarise(n=n())

msigdb_celltype_restricted <- rbind(ery, mk, ly, my)
```

```{r celltype}
celltype_gsea <- GSEA(geneList = ranked_ens[!is.na(ranked_ens)], 
                TERM2GENE = msigdb_celltype_restricted[,c('gs_name','ensembl_gene')],
                pvalueCutoff = 1)%>% 
  setReadable(OrgDb = org.Mm.eg.db, keyType = 'ENSEMBL')

celltype_up <- enricher(gene =deg_up$Ensembl_ID, 
                       TERM2GENE = msigdb_celltype_restricted[,c('gs_name','ensembl_gene')]) %>%
  setReadable(OrgDb = org.Mm.eg.db, keyType = 'ENSEMBL')

celltype_dn <- enricher(gene =deg_dn$Ensembl_ID, 
                       TERM2GENE = msigdb_celltype_restricted[,c('gs_name','ensembl_gene')]) %>%
  setReadable(OrgDb = org.Mm.eg.db, keyType = 'ENSEMBL')
```

```{r}
celltype_gsea_ens <- GSEA(geneList = ranked_ens[!is.na(ranked_ens)], 
                          TERM2GENE = msigdb_celltype_restricted[,c('gs_name','ensembl_gene')],
                          pvalueCutoff = 1)

tmp <- data.frame(ranked_ens) %>% rownames_to_column('Ensembl_ID') %>%
  left_join(d_exp[, c('Ensembl_ID','expressing')]) %>%
  mutate(rank = rank(ranked_ens))

for (gset in celltype_gsea@result$ID[celltype_gsea_ens@result$p.adjust <0.01]){
  core_enrichment <- unlist(strsplit(celltype_gsea_ens@result[gset, 'core_enrichment'], split = '/'))
  tmp[, gset] <- NA
  tmp[tmp$Ensembl_ID %in% core_enrichment,gset] <- T
}

tmp <- tmp %>% pivot_longer(cols = -c(1,2,3,4), names_to = 'gset') 

ggplot(tmp %>% filter(!is.na(value)), aes(x = rank, y = gset)) + geom_point(aes(col = expressing), shape = 124) + scale_color_viridis_d()
```


## GSEA plots
```{r plots}
ery_gsea <- celltype_gsea %>% filter(grepl('ERYTHR', ID))
ery_colors <- ifelse(ery_gsea@result$p.adjust < 0.01, 'red3', 'grey60')
names(ery_colors) <- ery_gsea@result$Description
ery_plot <- gseaplot2(ery_gsea, geneSetID = 1:ncol(ery_gsea@result), 
                      subplots = 1) + 
  geom_hline(yintercept = 0) + ylim(c(-0.6,0.6)) + guides(col = 'none') + 
  scale_color_manual(values = ery_colors) + 
  labs(title = 'erythroid_celltypes')


mk_gsea <- celltype_gsea %>% filter(grepl('MEGAKARY', ID))
mk_colors <- ifelse(mk_gsea@result$p.adjust < 0.01, 'red3', 'grey60')
names(mk_colors) <- mk_gsea@result$Description
mk_plot <- gseaplot2(mk_gsea, geneSetID = 1:ncol(mk_gsea@result), 
                      subplots = 1) + 
  geom_hline(yintercept = 0) + ylim(c(-0.6,0.6)) + guides(col = 'none') + 
  scale_color_manual(values = mk_colors) + 
  labs(title = 'megakaryocytic_celltypes')


ly_gsea <- celltype_gsea %>% filter(grepl('LYMPHO', ID))
ly_colors <- ifelse(ly_gsea@result$p.adjust < 0.01, 'turquoise4', 'grey60')
names(ly_colors) <- ly_gsea@result$Description
ly_plot <- gseaplot2(ly_gsea, geneSetID = 1:ncol(ly_gsea@result), 
                      subplots = 1) + 
  geom_hline(yintercept = 0) + ylim(c(-0.6,0.6)) + guides(col = 'none') + 
  scale_color_manual(values = ly_colors) + labs(title = 'lymphoid_celltypes')


my_gsea <- celltype_gsea %>% filter(grepl('MYELOID|MICROGLIA|KUPFER', ID))
my_colors <- ifelse(my_gsea@result$p.adjust < 0.01, 'limegreen', 'grey60')
names(my_colors) <- my_gsea@result$Description
my_plot <- gseaplot2(my_gsea, geneSetID = 1:ncol(my_gsea@result), 
                      subplots = 1) + 
  geom_hline(yintercept = 0) + ylim(c(-0.6,0.6)) + guides(col = 'none') + 
  scale_color_manual(values = my_colors) + labs(title = 'myeloid_celltypes')


celltype_plot <- (ery_plot + my_plot + mk_plot + ly_plot) + 
  plot_layout(nrow = 2)

ggsave('./figures/hem_celltypes_msigdb.pdf',
       plot = celltype_plot, width =6, height = 6)
```

```{r}
write.xlsx(x = list('Over-representation_48hi' = celltype_up@result %>% filter(p.adjust<0.01),
                    'Over-representation_48lo' = celltype_dn@result %>% filter(p.adjust<0.01),
                    'GSEA_48hi' = celltype_gsea@result %>% filter(NES >0),
                    'GSEA_48lo' = celltype_gsea@result %>% filter(NES <0)),
           file = './figures/tables/enrichment_celltype.xlsx', 
           asTable = T)
```


